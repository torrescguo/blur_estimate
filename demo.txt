

#include <iostream>
#include <opencv2/highgui/highgui.hpp>
#include <opencv2/imgproc/imgproc.hpp>
#include <opencv2/imgproc/types_c.h>
#include <math.h>

// #include "./driver/uvc_cam_sdk.h"
//  #include "./driver/bmp.h"
 #include "./driver/include/hello.h"
using namespace std;
using namespace cv;


// void start_uvc_camera()
// {
//     char path_f408_firstNode[50];
//     udev_search_node(path_f408_firstNode,0);
//     uvc_camera_sdk_init(path_f408_firstNode,640,800,1);
// }
#define GAMMA_VALUE 2.2
uint8_t gamma_lut[256];
void generate_gamma_lut(uint8_t *lut,float gamma_value)
{

    for (int i = 0;i < 256;i++)
    {
        float in = float(i) / 255.f;
        lut[i] = (uint8_t)(pow(in,1.f/gamma_value)*255.f);
    }
}


void gamma_correction(uint8_t *source,int width,int height,uint8_t *lutPtr)
{
    for (int i = 0;i < height;i++)
    {
        for (int j = 0;j < width;j++)
        {
            source[i*width+j] = lutPtr[source[i*width+j]];
        }
    }
}
 
int main()
{
    // BMP_DATA ff;
    log22();
    // start_uvc_camera();
	Mat imageSource = imread("../640x400.jpg");
	Mat imageGrey;
 
	cvtColor(imageSource, imageGrey, CV_RGB2GRAY);

    cout << imageGrey.cols << "\n" << imageGrey.rows << endl;
    generate_gamma_lut(gamma_lut,GAMMA_VALUE);

    gamma_correction(imageGrey.data,imageGrey.cols,imageGrey.rows,gamma_lut);
    

	Mat imageSobel;
	Sobel(imageGrey, imageSobel, CV_16U, 1, 1);
 
	//图像的平均灰度
	double meanValue = 0.0;
	meanValue = mean(imageSobel)[0];
 
	//double to string
	stringstream meanValueStream;
	string meanValueString;
	meanValueStream << meanValue;
	meanValueStream >> meanValueString;
	meanValueString = "Articulation(Sobel Method): " + meanValueString;
	putText(imageSource, meanValueString, Point(20, 50), 3, 0.8, Scalar(255, 255, 25), 2);
	imshow("Articulation", imageSource);
    imshow("Articulation_1", imageGrey);
	waitKey();
}